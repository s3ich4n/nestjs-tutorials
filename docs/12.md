# ì˜ˆì™¸ í•„í„°

> "Everything fails all the time."
>
> Werner Vogels, AWS CTO

ì–´ë–¤ ìƒí™©ì—ì„œë“  ì—ëŸ¬ëŠ” ë‚œë‹¤. ëŒ€ì‘ì±…ì„ ë§ˆë ¨í•´ë‘ì–´ì•¼ í•˜ëŠ” ê²ƒì€ í•„ìˆ˜ë‹¤. ê·¸ë ‡ë‹¤ë©´ ì˜ˆì™¸ì²˜ë¦¬ ì½”ë“œë¥¼ ì–´ë”” ë‘ëŠ” ê²ƒì´ ì¢‹ì„ê¹Œ?

ì—ëŸ¬ê°€ ë°œìƒí•  ë§Œí•œ **ëª¨ë“  ê³³**ì— ë‘ëŠ” ê²ƒì€ ì ì ˆí•˜ì§€ ì•Šë‹¤. ì½”ë“œ ê´€ë¦¬ëŠ” ì–´ë–»ê²Œ í•  ê²ƒì´ë©°, í•µì‹¬ê¸°ëŠ¥ êµ¬í˜„ ì´í•´ë¥¼ ë°©í•´í•œë‹¤.

ê·¸ë ‡ë‹¤ë©´ ë³„ë„ì˜ ëª¨ë“ˆì„ ë‘ê³  ì—ëŸ¬ë¥¼ ê³µí†µìœ¼ë¡œ ì²˜ë¦¬í•  ìˆ˜ ìˆë„ë¡ í•´ë³´ì.

## 12.1 ì˜ˆì™¸ ì²˜ë¦¬

NestëŠ” í”„ë ˆì„ì›Œí¬ì— ì˜ˆì™¸ ë ˆì´ì–´ë¥¼ ë‘ê³ ìˆë‹¤. ê¸°ë³¸ì ì¸ ì˜ˆì™¸ì²˜ë¦¬ëŠ” Nest ë‹¨ì—ì„œ ì²˜ë¦¬ëœë‹¤. ì—ëŸ¬ë¥¼ ë°œìƒì‹œì¼œë³´ì.

```ts
import { InternalServerErrorException } from '@nestjs/common';

@Controller()
export class AppController {
  (ìƒëµ)

  @Get('/error')
  error(foo: any): string {
    return foo.bar();   // fooëŠ” Undefinedë‹ˆ, ì—ëŸ¬ê°€ í„°ì§„ë‹¤.
  }
}
```

ì´ëŸ¬ë©´ ì‘ë‹µê°’ìœ¼ë¡œ 500ì—ëŸ¬ë¥¼ ë¦¬í„´í•˜ë©°, JSON í˜•ì‹ìœ¼ë¡œ ì²˜ë¦¬í•œë‹¤. ì´ í•„í„°ëŠ” ì¸ì‹í•  ìˆ˜ ì—†ëŠ” ì—ëŸ¬(`HttpException`ë„ ì•„ë‹ˆê³ , `HttpException`ì„ ìƒì†ë°›ì€ ì—ëŸ¬ë¥¼ ì˜ë¯¸)ë¥¼ `InternalServerErrorException` ìœ¼ë¡œ ë³€í™˜í•´ì¤€ë‹¤.

```shell
â¯ http GET localhost:3000/error
HTTP/1.1 500 Internal Server Error
Connection: keep-alive
Content-Length: 52
Content-Type: application/json; charset=utf-8
Date: Sat, 05 Aug 2023 18:14:30 GMT
ETag: W/"34-rlKccw1E+/fV8niQk4oFitDfPro"
Keep-Alive: timeout=5
X-Powered-By: Express

{
    "message": "Internal server error",
    "statusCode": 500
}

```

HTTP responseì˜ 400 ì—ëŸ¬ Bad Requestì— í•´ë‹¹í•˜ëŠ” ì˜ˆì™¸ì²˜ë¦¬ ì½”ë“œ(`BadRequestException`)ë¥¼ ì‚´í´ë³´ì:

```ts
@Get('/:id')
async getUserInfo(@Param('id') userId: string): Promise<UserInfo> {
  if (+userId < 1) {
    throw new BadRequestException('id is greater than 0');
  }
  return await this.usersService.getUserInfo(userId);
}
```

```shell
â¯ http GET localhost:3000/users/0
HTTP/1.1 400 Bad Request
Connection: keep-alive
Content-Length: 73
Content-Type: application/json; charset=utf-8
Date: Sat, 05 Aug 2023 19:02:59 GMT
ETag: W/"49-Q1p8MmyyLVw412Aew2fgB5Cauvw"
Keep-Alive: timeout=5
X-Powered-By: Express

{
    "error": "Bad Request",
    "message": "id is greater than 0",
    "statusCode": 400
}

```

Nestì˜ ê¸°ë³¸ ì˜ˆì™¸ í´ë˜ìŠ¤ë¥¼ ì‚´í´ë³´ì. ë³´ë‹¤ ìƒìœ„ì˜ í´ë˜ìŠ¤ëŠ” `HttpException` ì´ë¯€ë¡œ, ì´ë¥¼ ìƒì†í•´ì„œ ì‚¬ìš©í•˜ë ¤ë©´ ì•„ë˜ì™€ ê°™ì´ ì‚¬ìš©í•œë‹¤.

```ts
throw new HttpException(
  {
    errorMessage: 'id is greater than 0',
    foo: 'bar'
  },
  HttpStatus.BAD_REQUEST
)
```

`BadRequestException` ì˜ êµ¬í˜„ì²´ëŠ” ì•„ë˜ì™€ ê°™ë‹¤([ì¶œì²˜](https://github.com/nestjs/nest/blob/master/packages/common/exceptions/bad-request.exception.ts)):

```ts
export class BadRequestException extends HttpException {
  constructor(
    objectOrError?: string | object | any,
    descriptionOrOptions: string | HttpExceptionOptions = 'Bad Request',
  ) {
    const { description, httpExceptionOptions } =
      HttpException.extractDescriptionAndOptionsFrom(descriptionOrOptions);

    super(
      HttpException.createBody(
        objectOrError,
        description,
        HttpStatus.BAD_REQUEST,
      ),
      HttpStatus.BAD_REQUEST,
      httpExceptionOptions,
    );
  }
}
```

ì´ëŸ° ì‹ìœ¼ë¡œ, í•„ìš”ì— ì˜í•´ HttpExceptionì„ ìƒì†ë°›ì€ í´ë˜ìŠ¤ë¥¼ ë§Œë“ ë‹¤ë©´ ì´ë ‡ê²Œ ì ‘ê·¼í•˜ë©´ ëœë‹¤.

ê·¸ ì™¸ì˜ HTTP status codeì— í•´ë‹¹í•˜ëŠ” Nestì˜ í‘œì¤€ ì˜ˆì™¸ëŠ” [í•´ë‹¹ ë§í¬](https://docs.nestjs.com/exception-filters) ë¥¼ ì°¸ì¡°í•˜ì—¬ ì‚´í´ë³´ì.


## 12.2 ì˜ˆì™¸ í•„í„°

Nestì˜ ì „ì—­í•„í„° ì´ì™¸ì—ë„ ì˜ˆì™¸ í•„í„° ë ˆì´ì–´ë¥¼ ë‘ì–´ ì›í•˜ëŠ” ëŒ€ë¡œ ì˜ˆì™¸ì²˜ë¦¬ë¥¼ ìˆ˜í–‰í•  ìˆ˜ë„ ìˆë‹¤.

ì˜ˆì™¸ ë°œìƒ ì‹œ ëª¨ë“  ì˜ˆì™¸(`Error`, ëª¨ë“  ì˜ˆì™¸ì˜ ìƒìœ„ ê°ì²´) ë¥¼ ì¡ì•„ì„œ ìš”ì²­ URLê³¼ ì˜ˆì™¸ ë°œìƒì‹œê°ì„ ì½˜ì†”ì— ì°ëŠ” í•„í„°ë¥¼ ë§Œë“¤ì–´ë³´ì:

- ëª¨ë“ˆ ìƒì„±

> `nest g mo exception` -> `exception` ëª¨ë“ˆ ìƒì„±

- ì½”ë“œ ìƒì„¸

> `src/exception/http-exception.filter.ts`

```ts
import {
  ArgumentsHost,
  Catch,
  ExceptionFilter,
  HttpException,
  InternalServerErrorException,
} from '@nestjs/common';
import { Request, Response } from 'express';

@Catch()    // ì²˜ë¦¬ë˜ì§€ ì•ŠëŠ” ì˜ˆì™¸ë¥¼ ì¡ëŠ” ë°©ì•ˆ
export class HttpExceptionFilter implements ExceptionFilter {
  catch(exception: Error, host: ArgumentsHost) {
    const ctx = host.switchToHttp();
    const res = ctx.getResponse<Response>();
    const req = ctx.getRequest<Request>();

    if (!(exception instanceof HttpException)) {    // HttpExceptionì´ ì•„ë‹Œ ê²½ìš°, InternalServerErrorExceptionìœ¼ë¡œ ì²˜ë¦¬
      exception = new InternalServerErrorException();
    }

    const response = (exception as HttpException).getResponse();

    const log = {
      timestamp: new Date(),
      url: req.url,
      response,
    };

    console.log(log);

    res.status((exception as HttpException).getStatus()).json(response);
  }
}
```

ì´ëŸ° ì˜ˆì™¸ì²˜ë¦¬ëŠ” `@UseFilter` ë°ì½”ë ˆì´í„°ë¥¼ ì—”ë“œí¬ì¸íŠ¸, ì»¨íŠ¸ë¡¤ëŸ¬, ì• í”Œë¦¬ì¼€ì´ì…˜ ë‹¨ìœ„ë¡œ ì„¤ì •í•  ìˆ˜ ìˆë‹¤.

- ì—”ë“œí¬ì¸íŠ¸ ì„¤ì •ë°©ì•ˆ

```ts
@Controller('users')
export class UsersController {
  (ìƒëµ)

  @UseFilters(HttpExceptionFilter)
  @Post()
  async createUser(@Body(ValidationPipe) dto: CreateUserDto): Promise<void> {
    this.printLoggerServiceLog(dto);

    const { name, email, password } = dto;
    await this.usersService.createUser(name, email, password);
  }
  (ì¤‘ëµ)
```

- íŠ¹ì • ì»¨íŠ¸ë¡¤ëŸ¬ ì „ì²´ì— ì ìš©

```ts
@Controller('Users')
@UseFilters(HttpExceptionFilter)
export class UsersController {
  (ì¤‘ëµ)

```

- ì• í”Œë¦¬ì¼€ì´ì…˜ ì „ì²´ì— ì ìš©

```ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule, {
  (ìƒëµ)
  app.useGlobalPipes(
    // new ValidationPipe({
    //   transform: true,
    // }),
  );
  app.useGlobalFilters(
    new HttpExceptionFilter(); // ì „ì—­ í•„í„°ë¡œ ì ìš©
  )
  await app.listen(3000);
}
```

ê·¸ëŸ°ë° ì´ëŸ° ì‹ìœ¼ë¡œ ì‚¬ìš©í•˜ë©´, í•„í„°ì— ì˜ì¡´ì„±ì„ ì£¼ì…í•  ìˆ˜ ì—†ë‹¤. ì˜ˆì™¸ í•„í„°ì˜ ìˆ˜í–‰ì´ ì˜ˆì™¸ ë°œìƒ ëª¨ë“ˆ ì™¸ë¶€(`main.ts`)ì—ì„œ ë°œìƒí•˜ê¸° ë•Œë¬¸ì´ë‹¤.

ì˜ì¡´ì„± ì£¼ì…ì„ ìœ„í•´ì„œëŠ” ì˜ˆì™¸ í•„í„°ë¥¼ ì»¤ìŠ¤í…€ í”„ë¡œë°”ì´ë”ë¡œ ë“±ë¡ í›„, íƒ€ í”„ë¡œë°”ì´ë”ë¥¼ ì£¼ì…ë°›ì•„ ì‚¬ìš©í•œë‹¤.

> `src/exception/exception.module.ts`

```ts
import { Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { HttpExceptionFilter } from './http-exception.filter';

@Module({
  providers: [
    {
      provide: APP_FILTER,
      useClass: HttpExceptionFilter,
    },
  ],
})
export class ExceptionModule {}

```

ì´í›„ `HttpExceptionFilter` ì—ì„œ í”„ë¡œë°”ì´ë” ì£¼ì…ë°›ì€ í›„ ì‚¬ìš©:

> `src/exception/http-exception.filter.ts`

```ts
import {
  (ìƒëµ)
  Logger,
} from '@nestjs/common';
import { Request, Response } from 'express';

@Catch()
export class HttpExceptionFilter implements ExceptionFilter {
  constructor(private logger: Logger) {}

  catch(exception: Error, host: ArgumentsHost) {
    (ìƒëµ)

    this.logger.log(log);

    res.status((exception as HttpException).getStatus()).json(response);
  }
}

```

try/catch ë¡œ ì¡ì§€ ëª»í•œ ì˜ˆì™¸ë¥¼ ìºì¹˜í•˜ëŠ” ê²ƒì€ ë‚˜ë¨¸ì§€ ìƒëª…ì£¼ê¸°ë¥¼ ë¬´ì‹œí•˜ê³  ì˜ˆì™¸ í•„í„° ë¡œì§ì„ íƒ„ë‹¤ëŠ” ê²ƒì— ìœ ì˜í•˜ì.

## 12.3 ìœ ì € ì„œë¹„ìŠ¤ì— ì˜ˆì™¸ í•„í„° ì ìš©í•˜ê¸°

`LoggerService` ì™€ `HttpExceptionFilter` ë¥¼ ì‚¬ìš©í•˜ì—¬ ì²˜ë¦¬í•´ë³´ì.

> `src/exception/exception.module.ts`

```ts
import { Logger, Module } from '@nestjs/common';
import { APP_FILTER } from '@nestjs/core';
import { HttpExceptionFilter } from './http-exception.filter';

@Module({
  providers: [
    Logger,
    {
      provide: APP_FILTER,
      useClass: HttpExceptionFilter,
    },
  ],
})
export class ExceptionModule {}

```

ì´ í›„ `ExceptionModule` ì„ `AppModule`ë¡œ ê°€ì ¸ì˜¨ë‹¤.

> `src/app.module.ts`

```ts
@Module({
  imports: [
    (ìƒëµ)
    ExceptionModule,
  ],
  controllers: [],
  providers: [],
})
export class AppModule {}
```

> ğŸ… tips
>
> `nest g mo exception` ìœ¼ë¡œ ìƒì„±í•˜ë©´
>
> ìë™ìœ¼ë¡œ ëª¨ë“ˆì„ import í•œë‹¤.

ê·¸ë¦¬ê³  ì½˜ì†”ë¡œê·¸ ëŒ€ì‹ , Loggerë¥¼ í†µí•´ ë¡œê·¸ë¥¼ ì°ë„ë¡ í•˜ê³ , ì½œìŠ¤íƒì„ í•¨ê»˜ ë³´ë„ë¡ `HttpExceptionFilter`ë¥¼ ìˆ˜ì •í•´ë³´ì.

```ts
@Catch()
export class HttpExceptionFilter implements ExceptionFilter {
  constructor(private logger: Logger) {}

  catch(exception: Error, host: ArgumentsHost) {
    (ìƒëµ)
    const stack = exception.stack;
    
    (ìƒëµ)
    const log = {
      timestamp: new Date(),
      url: req.url,
      response,
      stack,
    };

    this.logger.log(log);
    (í›„ëµ)
```
