# ìš”ì²­ ì²˜ë¦¬ ì „ ë¶€ê°€ê¸°ëŠ¥ì„ ìˆ˜í–‰í•˜ê¸° ìœ„í•œ ë¯¸ë“¤ì›¨ì–´

## 9.1 ë¯¸ë“¤ì›¨ì–´

ì›¹ ê°œë°œì—ì„œì˜ ë¯¸ë“¤ì›¨ì–´: ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬ê°€ í´ë¼ì´ì–¸íŠ¸ ìš”ì²­ ì²˜ë¦¬ ì „ ìˆ˜í–‰ë˜ëŠ” ì»´í¬ë„ŒíŠ¸

```
[ í´ë¼ì´ì–¸íŠ¸ ] --- (HTTP ìš”ì²­) --> [ ë¯¸ë“¤ì›¨ì–´ ] --- --> [   ë¼ìš°íŠ¸ í•¸ë“¤ëŸ¬
                                                          (@RequestMapping)  ]
```

Nestì˜ ë¯¸ë“¤ì›¨ì–´ëŠ” ê¸°ë³¸ì ìœ¼ë¡œ Expressì˜ ë¯¸ë“¤ì›¨ì–´ê°€ ê°™ë‹¤. Expressì˜ ë¬¸ì„œì—ì„œëŠ” ë¯¸ë“¤ì›¨ì–´ì˜ ì—­í• ì„ ì•„ë˜ì™€ ê°™ì´ ê¸°ìˆ í•˜ì˜€ë‹¤:

1. ì–´ë–¤ í˜•íƒœì˜ ì½”ë“œë¼ë„ ìˆ˜í–‰ ê°€ëŠ¥
1. ìš”ì²­/ì‘ë‹µì— ë³€í˜•ì„ ê°€í•  ìˆ˜ ìˆìŒ
1. ìš”ì²­/ì‘ë‹µ ì£¼ê¸°ë¥¼ ëë‚¼ ìˆ˜ ìˆìŒ
1. ì—¬ëŸ¬ ê°œì˜ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•œë‹¤ë©´ `next()` ë¡œ í˜¸ì¶œ ìŠ¤íƒ ìƒ ë‹¤ìŒ ë¯¸ë“¤ì›¨ì–´ì— ì œì–´ê¶Œì„ ì „ë‹¬

ìš”ì²­/ì‘ë‹µ ì£¼ê¸°ë¥¼ ëë‚´ëŠ” ê²ƒì€ ì‘ë‹µì„ ë³´ë‚´ê±°ë‚˜, ì˜ˆì™¸ì²˜ë¦¬ë¥¼ í•œë‹¤ëŠ” ëœ»ì´ë©°, ë¯¸ë“¤ì›¨ì–´ê°€ ì‘ë‹µì£¼ê¸°ë¥¼ ëë‚´ì§€ ì•Šì„ ê²ƒì´ë¼ë©´ **ë°˜ë“œì‹œ** `next()` ë¥¼ í˜¸ì¶œí•´ì•¼í•œë‹¤. ê·¸ë ‡ì§€ ì•Šìœ¼ë©´ ì• í”Œë¦¬ì¼€ì´ì…˜ì´ ì•„ëª¨ê²ƒë„ í•  ìˆ˜ ì—†ëŠ” ìƒíƒœ(_hanging_)ê°€ ëœë‹¤.

ë¯¸ë“¤ì›¨ì–´ë¥¼ í†µí•´ ì•„ë˜ ì‘ì—…ì„ í•  ìˆ˜ ìˆë‹¤

- ì¿ í‚¤ íŒŒì‹±: ë¼ìš°í„° í•¸ë“¤ëŸ¬ì—ì„œ ë§¤ë²ˆ íŒŒì‹±í•˜ì§€ ì•Šì•„ë„ ë¨
- ì„¸ì…˜ ê´€ë¦¬: ì„¸ì…˜ ì¿ í‚¤ë¥¼ ì°¾ê³ , ì¿ í‚¤ì— ëŒ€í•œ ì„¸ì…˜ ìƒíƒœë¥¼ ì¡°íšŒ í›„ ìš”ì²­ì— ì„¸ì…˜ì •ë³´ë¥¼ ì¶”ê°€í•¨. ì´ë¥¼ í†µí•´ ë‹¤ë¥¸ í•¸ë“¤ëŸ¬ê°€ ì„¸ì…˜ê°ì²´ë¥¼ ì“¸ ìˆ˜ ìˆë„ë¡ í•¨
- ì¸ì¦/ì¸ê°€: ì‚¬ìš©ìê°€ ì„œë¹„ìŠ¤ì— ì ‘ê·¼ê¶Œí•œì´ ìˆëŠ”ì§€ í™•ì¸. NestëŠ” ì´ ê²½ìš° [Guards](https://docs.nestjs.com/guards) ë¼ëŠ” ê¸°ëŠ¥ì„ í™œìš”í•œë‹¤.
- ë³¸ë¬¸ íŒŒì‹±: ë°”ë””ì— ì˜¤ëŠ” JSON íƒ€ì… ë¿ ì•„ë‹ˆë¼ íŒŒì¼ ìŠ¤íŠ¸ë¦¼ ë“±ì˜ ë°ì´í„°ë¥¼ ì½ê³  íŒŒë¼ë¯¸í„°ì— ë„£ëŠ”ë‹¤.

ì»¤ìŠ¤í…€ ê¸°ëŠ¥ë„ ì¶”ê°€ê°€ëŠ¥í•˜ë‹¤. ì´ë¥¼ í†µí•´ ë„ë©”ì¸ì— ì§‘ì¤‘í•  ìˆ˜ ìˆë‹¤. (ê³µí†µ ë™ì‘ì„ ì ì ˆíˆ ìˆ¨ê²¨ì„œ?)

ë¯¸ë“¤ì›¨ì–´ì™€ ë¹„ìŠ·í•œ Nestì˜ [Interceptors](https://docs.nestjs.com/interceptors) ë„ ìˆë‹¤.

## 9.2 `Logger` ë¯¸ë“¤ì›¨ì–´ êµ¬í˜„í•´ë³´ê¸°

ìš”ì²­ë§ˆë‹¤ 'request...' ë¥¼ ì°ëŠ” ë¯¸ë“¤ì›¨ì–´ë¥¼ êµ¬í˜„í•´ë³´ì.

```ts
import { Injectable, NestMiddleware } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';

@Injectable()
export class LoggerMiddleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    console.log('request...');
    next();
  }
}
```

ì´ëŠ” `app.module.ts` ì˜ `AppModule` ì— `NestModule` ì¸í„°í˜ì´ìŠ¤ë¥¼ êµ¬í˜„í•´ì•¼í•œë‹¤. `configure` í•¨ìˆ˜ë¥¼ ì‘ì„±í•œë‹¤.

```ts
@Module({
 ..
})
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer): any {
    consumer.apply(LoggerMiddleware).forRoutes('/users');
  }
}
```

ì´ëŸ¬ë©´ `/users` ë¡œ ê°€ëŠ” ë§¤ ìš”ì²­ë§ˆë‹¤ 'request...' ë¼ëŠ” ë¡œê·¸ê°€ ì°íŒë‹¤.

## 9.3 `MiddlewareConsumer` ë€?

ì € íƒ€ì…ì€ ë¬´ì—‡ì´ë©°, `.apply()` ë¼ëŠ” ë©”ì†Œë“œì˜ ì›í˜•ì— ì–´ë–¤ì‹ìœ¼ë¡œ ê°’ì„ ë„£ì„ ìˆ˜ ìˆëŠ” ê²ƒì¸ì§€ ì‚´í´ë³´ì.

```ts
/**
 * @param {...(Type | Function)} middleware middleware class/function or array of classes/functions
 * to be attached to the passed routes.
 * @returns {MiddlewareConfigProxy}
 */
apply(...middleware: (Type<any> | Function)[]): MiddlewareConfigProxy;
```

ë¯¸ë“¤ì›¨ì–´ë¡œ ì‚¬ìš©í•  í•¨ìˆ˜, í´ë˜ìŠ¤ë¥¼ ì½¤ë§ˆë¡œ ë‚˜ì—´í•˜ë©°, ìˆœì„œëŒ€ë¡œ ì ìš©ëœë‹¤.

...ì´ëŸ° ì½”ë“œë¥¼ ì§œê³ ,

```ts
import { Injectable, NestMiddleware } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';

@Injectable()
export class Logger2Middleware implements NestMiddleware {
  use(req: Request, res: Response, next: NextFunction) {
    console.log('request2...');
    next();
  }
}
```

... ì´ë ‡ê²Œ ê°€ì ¸ë‹¤ë¶™ì´ë©´,

```ts
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer): any {
    consumer.apply(LoggerMiddleware, Logger2Middleware).forRoutes('/users');
  }
}
```

ë§¤ `/users` ë¼ìš°í„°ë¡œ ê°€ëŠ” ìš”ì²­ë§ˆë‹¤ request... request2... ê°€ ìˆœì„œëŒ€ë¡œ ë¶™ëŠ”ë‹¤.

`forRoutes()` ì˜ ì—­í• ì„ ì‚´í´ë³´ì.

```ts
/**
 * Attaches passed either routes or controllers to the currently configured middleware.
 * If you pass a class, Nest would attach middleware to every path defined within this controller.
 *
 * @param {(string | Type | RouteInfo)[]} routes
 * @returns {MiddlewareConsumer}
 */
forRoutes(...routes: (string | Type<any> | RouteInfo)[]): MiddlewareConsumer;
```

ë³´ë‹¤ë³´ë‹ˆ, `exclude` ë¼ëŠ” ë©”ì†Œë“œë„ ìˆë‹¤. ì´ëŠ” í¬í•¨í•˜ì§€ ë§ë¼ëŠ” ê²½ë¡œë‹¤.

```ts
/**
 * Excludes routes from the currently processed middleware.
 *
 * @param {(string | RouteInfo)[]} routes
 * @returns {MiddlewareConfigProxy}
 */
exclude(...routes: (string | RouteInfo)[]): MiddlewareConfigProxy;
```

ë³´í†µì€ `/users` ì²˜ëŸ¼ ë„£ì„ ê²Œ ì•„ë‹ˆë¼ ì»¨íŠ¸ë¡¤ëŸ¬ í´ë˜ìŠ¤ë¥¼ ë„£ì–´ì£¼ì–´ ì²˜ë¦¬í•œë‹¤.

```ts
export class AppModule implements NestModule {
  configure(consumer: MiddlewareConsumer): any {
    consumer.apply(LoggerMiddleware, Logger2Middleware).forRoutes(UsersController);
  }
}
```

ë¯¸ë“¤ì›¨ì–´ì˜ `next()` ë¥¼ êµ¬í˜„í•˜ì§€ ì•Šìœ¼ë©´ ì•„ë¬´ë™ì‘ë„ ëª»í•˜ê³ , responseë¥¼ ë°”ë¡œ ë³´ë‚´ë²„ë¦¬ë©´ ë‹¤ë¥¸ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì•ˆ íƒ„ë‹¤.

## 9.4 ì „ì—­ìœ¼ë¡œ ì ìš©í•˜ê¸°

ë¯¸ë“¤ì›¨ì–´ë¥¼ **ëª¨ë“  ëª¨ë“ˆ**ì— ì ìš©í•˜ë ¤ë©´ `main.ts` ë¥¼ ìˆ˜ì •í•œë‹¤. `NestFactory.create` ë¡œ ì œì‘í•œ ì•±ì€ `INestApplication` íƒ€ì…ì„ ê°€ì§. ì—¬ê¸° ì •ì˜ëœ `use()` ë©”ì†Œë“œë¥¼ ì‚¬ìš©í•˜ì—¬ ë¯¸ë“¤ì›¨ì–´ë¥¼ ì„¤ì •í•¨. (ì°¸ê³ : í´ë˜ìŠ¤ë¥¼ ì•„ê·œë¨¼íŠ¸ë¡œ ë°›ì„ ìˆ˜ ì—†ìŒ)

ì¦‰, ì´ëŸ° ì‹ìœ¼ë¡œ ì •ì˜í•˜ê³ ...

```ts
import { Injectable, NestMiddleware } from '@nestjs/common';
import { Request, Response, NextFunction } from 'express';

export function Logger3Middleware(
  req: Request,
  res: Response,
  next: NextFunction,
) {
  console.log('request3...');
  next();
}
```

... `main.ts` ì— ì ìš©í•˜ë©´

```ts
(ìƒëµ)

async function bootstrap() {
  (ìƒëµ)
  app.use(Logger3Middleware);
  await app.listen(3000);
}
bootstrap();
```

ëª¨ë“  ìš”ì²­ì— ì•ì„œ ë™ì‘í•œë‹¤.

> ğŸ… tips
>
> í•¨ìˆ˜ë¡œ ë§Œë“  ë¯¸ë“¤ì›¨ì–´ëŠ” DI ì»¨í…Œì´ë„ˆë¥¼ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
>
> í”„ë¡œë°”ì´ë”ë¥¼ ì£¼ì…ë°›ì•„ ì‚¬ìš©í•  ìˆ˜ ì—†ë‹¤.
