# 로깅

의미있는 로그 하나하나가 후에 크게 도움이 된다. 겪어보니 알겠다. 단독적으로 필요한 정보를 나타내는 로그는 시스템이 돌아가는 것을 파악하기 훨씬 쉽게 도와준다.

그렇다면 Nest의 내장로거를 알아보고 [nest-winston](https://github.com/gremo/nest-winston) 사용법에 대해 알아보자.

## 11.1 내장 로거

```log
[3:04:31 AM] File change detected. Starting incremental compilation...

[3:04:31 AM] Found 0 errors. Watching for file changes.

[Nest] 34639  - 07/26/2023, 3:04:31 AM     LOG [NestFactory] Starting Nest application...
[Nest] 34639  - 07/26/2023, 3:04:31 AM     LOG [InstanceLoader] AppModule dependencies initialized +24ms
(생략)
[Nest] 34639  - 07/26/2023, 3:04:32 AM     LOG [RoutesResolver] UsersController {/users}: +5ms
[Nest] 34639  - 07/26/2023, 3:04:32 AM     LOG [RouterExplorer] Mapped {/users, POST} route +1ms
(생략)
[Nest] 34639  - 07/26/2023, 3:04:32 AM     LOG [NestApplication] Nest application successfully started +1ms
```

내장 Logger 클래스는 `@nest/common` 패키지로 제공된다. 로깅 옵션을 조절하면 아래와같은 제어가 가능하다

- 로깅 비활성화
- 로그 레벨 지정
    - log, error, warn, debug, verbose
- 로거 타임스탬프 재정의. E.g., ISO 8601 스타일
- 기존 로거 재정의
- 커스텀 로거 작성
- 의존성 주입을 통한 로거 주입 및 테스트 모듈로 제공

내장 로거 인스턴스 생성 후, 프로그램 내에서 로그를 찍을 수 있다. 아래와 같이 코드를 짜면

```ts
import { Injectable, Logger } from '@nestjs/common';

@Injectable()
export class AppService {
  private readonly logger = new Logger(AppService.name);

  getHello(): string {
    this.logger.error('level: error');
    this.logger.warn('level: warn');
    this.logger.log('level: log');
    this.logger.verbose('level: verbose');
    this.logger.debug('level: debug');

    return "aa";
  }
}
```

...이런 로그가 찍힌다.

```log
[Nest] 41964  - 07/26/2023, 3:47:08 AM   ERROR [AppService] level: error
[Nest] 41964  - 07/26/2023, 3:47:08 AM    WARN [AppService] level: warn
[Nest] 41964  - 07/26/2023, 3:47:08 AM     LOG [AppService] level: log
[Nest] 41964  - 07/26/2023, 3:47:08 AM VERBOSE [AppService] level: verbose
[Nest] 41964  - 07/26/2023, 3:47:08 AM    WARN [AppService] level: debug
```

### 11.1.1 로깅 끄기

로깅 비활성화는 `NestFactory.create` 사용 시 `logger: false` 라는 옵션으로 가능하다.

```ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule, {
    logger: false,
  });
  await app.listen(3000);
}
bootstrap();
```

### 11.1.2 로그 레벨 지정

프로덕션에서는 debug 로그까지 남기지 않는 편이 좋다. 디버그 로그를 찍다보면, 자연스럽게 민감정보도 같이 찍힐 수 있기 때문이다.

실행환경에 따라 로그 레벨을 지정하는 방법은 아래와 같다:

```ts
async function bootstrap() {
  const app = await NestFactory.create(AppModule, {
    logger: process.env.NODE_ENV === 'production'
    ? ['error', 'warn', 'log']
    : ['error', 'warn', 'log', 'verbose', 'debug'],
  });
  await app.listen(3000);
}
bootstrap();
```

> 🍅 notes!
>
> 로그 레벨을 하나만 지정하면, 그 값보다 상위 레벨의 로그는 모두 찍는다.
>
> 0이 debug이고 1이 verbose, 2, 3, 4는 각각 log/warn/error 이다.

## 11.2 커스텀 로거

내장 로거는 로그 파일로 떨어뜨리거나, DB로 저장해주는 기능이 없다. 필요하면 구현해야한다. `@nestjs/common` 패키지의 `LoggerService` 인터페이스를 구현하는 것으로 수행할 수 있다.