# ì˜ì†í™”

NestëŠ” ë‹¤ì–‘í•œ ë°ì´í„°ë² ì´ìŠ¤ì™€ ì—°ê²°í•  ìˆ˜ ìˆë‹¤. Node.js ë“œë¼ì´ë²„ë§Œ ìˆìœ¼ë©´ ëª¨ë‘ ì—°ê²° ê°€ëŠ¥í•˜ë‹¤.

ë³¸ êµì¬ì—ì„œëŠ” MySQLê³¼ TypeORMì„ ì‚¬ìš©í•˜ì—¬ ë°ì´í„°ë¥¼ ë‹¤ë£¬ë‹¤.

## 8.1 MySQL ë°ì´í„°ë² ì´ìŠ¤ ì„¤ì •

docker compose íŒŒì¼ì„ ì‘ì„±í•˜ê³  MySQL ì»¨í…Œì´ë„ˆë¡œ êµ¬ë™í•œë‹¤.

DBì— ë¶™ê³  í…ŒìŠ¤íŠ¸í•´ë³´ëŠ” ë¶€ë¶„ì€ ë³„ë„ë¡œ ì„¤ëª…í•˜ì§€ ì•ŠëŠ”ë‹¤. (í„°ë¯¸ë„ë¡œ ë¶™ê±°ë‚˜, DBeaverë¡œ ë¶™ê±°ë‚˜...)

## 8.2 TypeORMìœ¼ë¡œ ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²°

Nestì— MySQLì„ ì—°ê²°í•˜ë ¤ë©´ ì•„ë˜ì™€ ê°™ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ê°€ í•„ìš”í•˜ë‹¤.

> ğŸ… notes!
>
> 2~3ì¼ ì „ í”„ë¡œì íŠ¸ë¥¼ ì‹œì‘í–ˆì„ ë• nestjsì˜ ì½”ì–´ë²„ì „ì„ 10.0.0ìœ¼ë¡œ ì´ˆê¸°í™” ì‹œì¼œì£¼ì—ˆë‹¤.
>
> ê·¸ë˜ì„œ êµì¬ì˜ ë¼ì´ë¸ŒëŸ¬ë¦¬ ì„¤ì¹˜ ì»¤ë§¨ë“œì™€ ë‹¤ë¥´ë‹¤

```bash
$ npm i typeorm@0.3.7 @nestjs/typeorm@10.0.0 mysql2
```

ì´í›„ `app.module.ts`ì— TypeORM ê´€ë ¨ ì„¤ì •ì„ ì¶”ê°€í•˜ë„ë¡ í•œë‹¤.

```ts
@Module({
  imports: [
    (ìƒëµ),
    TypeOrmModule.forRoot({
      type: 'mysql',
      host: process.env.DATABASE_HOST,
      port: 3306,
      username: process.env.DATABASE_USERNAME,
      password: process.env.DATABASE_PASSWORD,
      database: process.env.DATABASE_NAME,
      entities: [__dirname + '/**/*.entity{.ts,.js}'],
      synchronize: process.env.DATABASE_SYNCHRONIZE === 'true',   // â€¼ ì£¼ì˜ â€¼
      migrations: [__dirname + '/**/migrations/*.js'],
      migrationsTableName: 'migrations',
    }),
  ],
  controllers: [],
  providers: [],
})
export class AppModule {}
```

> â€¼ ì£¼ì˜ â€¼
>
> **ì ˆëŒ€ë¡œ í˜„ì—…ì—ì„œ ì´ë¥¼ `true` ë¡œ ë‘ì–´ ì‚¬ìš©í•˜ì§€ ë§ˆì‹­ì‹œì˜¤.**
>
> **ë°ì´í„°ë² ì´ìŠ¤ ì—°ê²° ì‹œ ë°ì´í„°ë² ì´ìŠ¤ê°€ ì´ˆê¸°í™”ë©ë‹ˆë‹¤.**

`TypeOrmModuleOptions`ì—ëŠ” ì–´ë–¤ ë‚´ìš©ì´ ìˆì„ê¹Œ? [ì†ŒìŠ¤ì½”ë“œ ì›ë³¸ ë§í¬](https://github.com/nestjs/typeorm/blob/master/lib/interfaces/typeorm-options.interface.ts)

```ts
export type TypeOrmModuleOptions = {
  retryAttempts?: number;
  retryDelay?: number;
  /**
   * @param err error that was thrown
   * @returns whether to retry connection or not
   */
  toRetry?: (err: any) => boolean;
  autoLoadEntities?: boolean;
  /**
   * @deprecated
   */
  keepConnectionAlive?: boolean;
  verboseRetryLog?: boolean;
} & Partial<DataSourceOptions>;
```

- í—·ê°ˆë¦¬ëŠ” ë¶€ë¶„ë§Œ ê¸°ìˆ í•œë‹¤:
  - `toRetry`: ì—ëŸ¬ ë°œìƒ ì‹œ ì—°ê²°ì„ ì‹œë„í• ì§€ íŒë‹¨í•˜ëŠ” ë©”ì†Œë“œ. ì½œë°±ìœ¼ë¡œ ë°›ì€ `err` ì•„ê·œë¨¼íŠ¸ë¥¼ ì´ìš©í•˜ì—¬ ì—°ê²°ì—¬ë¶€ë¥¼ íŒë‹¨í•˜ëŠ” í•¨ìˆ˜ë¥¼ êµ¬í˜„í•´ì„œ ì”€
  - `keepConnectionAlive`: (_deprecated_) ì• í”Œë¦¬ì¼€ì´ì…˜ ì¢…ë£Œ í›„ ì—°ê²°ì„ ìœ ì§€í• ì§€ì— ëŒ€í•œ ì—¬ë¶€
- íŠ¹ì´ì‚¬í•­ì„ ê¸°ìˆ í•œë‹¤:
  - `TypeOrmModuleOptions`ëŠ” `DataSourceOptions` íƒ€ì…ê³¼ì˜ Partial íƒ€ì…ì„ `&` í•œ íƒ€ì…ì´ë‹¤. ìƒì„¸ ì„¤ëª…ì€ [í•´ë‹¹ ë§í¬](https://github.com/typeorm/typeorm/blob/master/docs/data-source-options.md)ë¥¼ ì°¸ì¡°í•œë‹¤.

> ğŸ… tips
>
> Nestë¡œ ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì—°ê²°í•˜ë ¤ë©´ `ormconfig.json` ì´ë€ íŒŒì¼ë¡œë„ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.
>
> ë‹¤ë§Œ 0.3 ë²„ì „ì—ì„œëŠ” ì§€ì›í•˜ì§€ ì•Šìœ¼ë¯€ë¡œ ì£¼ì˜í•œë‹¤.

> ğŸ In Python? ğŸ
>
> FastAPI ì•± ì´ˆê¸°í™” ì‹œ Dependency Injectorë¥¼ í†µí•´ Singleton í˜•ì‹ìœ¼ë¡œ `db` ì»¤ë„¥ì…˜ì— ëŒ€í•œ ë³€ìˆ˜ë¥¼ ë§Œë“¤ê³ [^1][^2], `on_startup()` ì‹œ connectë¥¼ ìˆ˜í–‰í–ˆë‹¤[^3].
>
> TypeORM ê°™ì€ ë¼ì´ë¸ŒëŸ¬ë¦¬ëŠ” SQLAlchemyì´ë‹¤.

## 8.3 íšŒì› ê°€ì…ì„ ìš”ì²­í•œ ìœ ì €ì˜ ì •ë³´ ì €ì¥í•˜ê¸°

Nestì€ [Repository Pattern](https://learn.microsoft.com/ko-kr/dotnet/architecture/microservices/microservice-ddd-cqrs-patterns/infrastructure-persistence-layer-design)ì„ ì§€ì›í•œë‹¤. ì´ë¥¼ ìœ„í•´ "ìœ ì €" ì—”í‹°í‹°ë¥¼ ì •ì˜í•´ë³´ì. (ë§ì´ ë³¸ ëª¨ì–‘ìƒˆë‹¤. ë§ˆì¹˜ ìŠ¤í”„ë§ì—ì„œì˜ [JPA Entity](https://www.baeldung.com/jpa-entities)ì™€ ê°™ì€...)

> `src/users/entity/users.entity.ts`

```ts
import { Column, Entity, PrimaryColumn } from 'typeorm';

@Entity('User')
export class UserEntity {
  @PrimaryColumn()
  id: string;

  @Column({ length: 30 })
  name: string;

  @Column({ length: 60 })
  email: string;

  @Column({ length: 30 })
  password: string;

  @Column({ length: 60 })
  signupVerifyToken: string;
}
```

ì´ ì—”í‹°í‹°ë¥¼ ì‚¬ìš©í•˜ê¸° ìœ„í•´ì„œëŠ” TypeOrmModuleOptionsì˜ entities ì†ì„±ì˜ ê°’ìœ¼ë¡œ ì¶”ê°€ê°€ í•„ìš”í•˜ë‹¤.

ë³¸ êµì¬ì—ì„œëŠ” `dist` ë””ë ‰í† ë¦¬ ë‚´ì˜  `*.entity.ts`, `*.entity.js` ë¥¼ ì¶”ê°€í•˜ë„ë¡ í•´ë‘ì—ˆìœ¼ë¯€ë¡œ ì¶”ê°€ ì¡°ì¹˜ëŠ” í•„ìš”ì—†ë‹¤.

ì´ì œ ë³¸ê²©ì ìœ¼ë¡œ todoë¡œ ì²˜ë¦¬ëœ ë°ì´í„° ì €ì¥ì„ ì‹¤ì‹œí•´ë³´ì!

- `forFeature` ë©”ì†Œë“œë¥¼ í†µí•´ ìœ ì € ëª¨ë“ˆ ë‚´ì—ì„œ ì‚¬ìš©í•  repositoryë¥¼ ë“±ë¡í•œë‹¤.

  > `src/users/users.module.ts`

  ```ts
  import { TypeOrmModule } from '@nestjs/typeorm';
  import { UserEntity } from './entity/users.entity';

  @Module({
    imports: [
      ...
      TypeOrmModule.forFeature([UserEntity]),
    ],
    (ì¤‘ëµ)
  })
  export class UsersModule {}
  ```

- `UsersService`ì— `@InjectRepository` ë°ì½”ë ˆì´í„°ë¡œ ìœ ì € ì €ì¥ì†Œë¥¼ ì£¼ì…í•œë‹¤

  > `src/users/users.services.ts`

  ```ts
  @Injectable()
  export class UsersService {
    constructor(
      private emailService: EmailService,
      @InjectRepository(UserEntity) private usersRepository: Repository<UserEntity>,
    ) { }
    (ì¤‘ëµ)
  }
  ```

- ìœ ì € ì—”í‹°í‹° ê°ì²´ë¥¼ ë§Œë“¤ê³  DBì— ì €ì¥í•˜ëŠ” ë¡œì§ì„ êµ¬í˜„í•œë‹¤

  > `src/users/users.services.ts`

  ```ts
  private async saveUser(
    name: string,
    email: string,
    password: string,
    signupVerifyToken: string,
  ) {
    const user = new UserEntity();
    user.id = ulid();
    user.name = name;
    user.email = email;
    user.password = password;
    user.signupVerifyToken = signupVerifyToken;
    await this.usersRepository.save(user);
  }
  ```

- ìœ ì €ê°€ íšŒì›ê°€ì…ì´ ë˜ì–´ìˆëŠ”ì§€ í™•ì¸í•˜ëŠ” ë¡œì§ ë˜í•œ êµ¬í˜„í•  ìˆ˜ ìˆë‹¤. ì´ ê²½ìš°, ìœ ì €ê°€ ì¡´ì¬í•˜ë©´ `422 Unprocessable Entity` ë¥¼ ë¦¬í„´í•˜ì.

  > `src/users/users.services.ts`

  ```ts
  private async checkUserExists(emailAddress: string) {
    const user = await this.usersRepository.findOne({
      where: { email: emailAddress }
    });

    return user !== undefined;
  }
  ```

  > `src/users/users.service.ts`

  ```ts
  async createUser(name: string, email: string, password: string) {
    const userExist = await this.checkUserExists(email);

    if (userExist) {
      throw new UnprocessableEntityException('Unable to signup with this email address');
    }
    (ì¤‘ëµ)
  }
  ```

## 8.4 íŠ¸ëœì­ì…˜ ì ìš©

íŠ¸ëœì­ì…˜ì„ ì ìš©í•˜ë ¤ë©´ í•˜ê¸° ì‘ì—…ì´ ì„ í–‰ë˜ì–´ì•¼ í•œë‹¤:

- ê°ì²´ë¥¼ ì“°ê³ ì í•˜ëŠ” ì„œë¹„ìŠ¤ì— `DataSource` ê°ì²´ë¥¼ ì£¼ì…í•œë‹¤

  > `src/users/users.services.ts`

  ```ts
  @Injectable()
  export class UsersService {
    constructor(
      ...
      private dataSource: DataSource,
      ...
    ) { }
  }
  ```

TypeORMì—ì„œëŠ” ë‘ ê°€ì§€ ë°©ë²•ìœ¼ë¡œ íŠ¸ëœì­ì…˜ì„ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

1. `QueryRunner`ë¥¼ ì´ìš©, ë‹¨ì¼ DB ì»¤ë„¥ì…˜ ìƒíƒœë¥¼ ìƒì„±í•˜ê³  ê´€ë¦¬í•˜ê¸°
1. `transaction` ë©”ì†Œë“œë¥¼ ì§ì ‘ í˜¸ì¶œ

### 8.4.1 `QueryRunner` ì‚¬ìš©ë²•

- íŠ¸ëœì­ì…˜ì„ ê±´ë‹¤.

  > `src/users/users.services.ts`

  ```ts
  private async saveUserUsingQueryRunner(
    name: string,
    email: string,
    password: string,
    signupVerifyToken: string,
  ) {
    const queryRunner = this.dataSource.createQueryRunner();
    await queryRunner.connect()
    await queryRunner.startTransaction()

    try {
      const user = new UserEntity();
      user.id = ulid();
      user.name = name;
      user.email = email;
      user.password = password;
      user.signupVerifyToken = signupVerifyToken;

      await queryRunner.manager.save(user);

      await queryRunner.commitTransaction();
    } catch (e) {
      await queryRunner.rollbackTransaction();
    } finally {
      await queryRunner.release();
    }
  }
  ```

  - SQLAlchemyì—ì„œ ë´¤ë˜ ORM ì¿¼ë¦¬ ì ‘ê·¼ë²•ê³¼ ìœ ì‚¬í•˜ë‹¤!

### 8.4.2 `transaction` ë©”ì†Œë“œ ì§ì ‘ í˜¸ì¶œ

`dataSource` ê°ì²´ ë‚´ì˜ `transaction` ë©”ì†Œë“œë¥¼ ì§ì ‘ ì´ìš©í•  ìˆ˜ë„ ìˆë‹¤.

  > `src/users/users.services.ts`

  ```ts
  private async saveUserUsingTransaction(
    name: string,
    email: string,
    password: string,
    signupVerifyToken: string,
  ) {
    await this.dataSource.transaction(async manager => {
      const user = new UserEntity();
      user.id = ulid();
      user.name = name;
      user.email = email;
      user.password = password;
      user.signupVerifyToken = signupVerifyToken;

      await manager.save(user);
    });
  }
  ```

## 8.5 ë§ˆì´ê·¸ë ˆì´ì…˜

DBì˜ ë³€ê²½ì ì„ ì½”ë“œë¡œ ê´€ë¦¬í•  ìˆ˜ ìˆë‹¤.

`alembic`ì´ë‚˜, Djangoì˜ `migrate` ê´€ë ¨ ëª…ë ¹ì–´ë“¤ë¡œ ì ‘í•´ë³¸ ì  ìˆëŠ” ê²ƒë“¤ì´ë‹¤.

`TypeORM CLI`ë¡œ ëª…ë ¹ì–´ë¥¼ ìˆ˜í–‰í•´ì•¼í•œë‹¤. ë”°ë¼ì„œ `ts-node` íŒ¨í‚¤ì§€ë¥¼ ê¸€ë¡œë²Œë¡œ ì„¤ì¹˜í•´ì¤€ë‹¤.

```bash
$ npm i -g ts-node
```

`ts-node`ë¥¼ ì´ìš©í•˜ì—¬ í”„ë¡œì íŠ¸ ë””ë ‰í† ë¦¬ ë‚´ì—ì„œ `npm run typeorm` ì»¤ë§¨ë“œë¥¼ ì‹¤í–‰í•  ìˆ˜ ìˆë„ë¡ í•˜ì. ì´ë¥¼ í†µí•´ TypeORM CLIë¥¼ ì‹¤í–‰í•œë‹¤.

```json
  "scripts": {
    (ìƒëµ)
    "typeorm": "ts-node -r tsconfig-paths/register ./node_modules/typeorm/cli.js"
  },
```

> ë¬¸ì œì‚¬í•­ (1) ?
>
> í˜„ì¬ `typeorm` ë²„ì „ì—ì„  ì»¤ë§¨ë“œê°€ ì•ˆë¨¹ëŠ”ë‹¤! ë”°ë¼ì„œ í•´ë‹¹ ì»¤ë§¨ë“œë¡œ ë°”ê¿”ì¤€ë‹¤...
>
> - before: `"ts-node --r ts-node/register ./node_modules/typeorm/cli.js -d ormconfig.ts"`
>
> - after: `ts-node -r tsconfig-paths/register ./node_modules/typeorm/cli.js`
> 

> ë¬¸ì œì‚¬í•­ (2) ?
>
> `-d ormconfig.ts` << ì´ ì½”ë“œëŠ” deprecated!
>
> [ì°¸ê³ ë§í¬](https://github.com/typeorm/typeorm/blob/master/CHANGELOG.md#breaking-changes-1)

> ì£¼ì˜ì‚¬í•­
>
> ë„ì»¤ë¡œ ë„ìš´ RDBMSì— í…Œì´ë¸”ì´ _ì´ë¯¸_ ì¡´ì¬í•˜ëŠ”ì§€ í™•ì¸í•´ë³´ê³  ë§ˆì´ê·¸ë ˆì´ì…˜ ìˆ˜í–‰í•˜ê¸°

1. ë§ˆì´ê·¸ë ˆì´ì…˜ ì‹œì‘ -> ì´ˆì°½ê¸° í´ë˜ìŠ¤ ìƒì„±

```bash
npm run typeorm migration:create src/migrations/CreateUserTable

> nest-tutorials@0.0.1 typeorm
> ts-node -r tsconfig-paths/register ./node_modules/typeorm/cli.js migration:create src/migrations/CreateUserTable

Migration /home/l4in/study/node/nest-tutorials/src/migrations/1690123649223-CreateUserTable.ts has been generated successfully.
```

2. ë§ˆì´ê·¸ë ˆì´ì…˜ ìƒì„±

```bash
npm run typeorm migration:generate src/migrations/CreateUserTable -- -d ./ormconfig.ts

> nest-tutorials@0.0.1 typeorm
> ts-node -r tsconfig-paths/register ./node_modules/typeorm/cli.js migration:generate src/migrations/CreateUserTable -d ./ormconfig.ts

Migration /home/l4in/study/node/nest-tutorials/src/migrations/1690125372875-CreateUserTable.ts has been generated successfully.
```

3. ë§ˆì´ê·¸ë ˆì´ì…˜ ì ìš©

```bash
$ npm run typeorm migration:run -- -d ./ormconfig.ts
> nest-tutorials@0.0.1 typeorm
> ts-node -r tsconfig-paths/register ./node_modules/typeorm/cli.js migration:run -d ./ormconfig.ts

query: SELECT VERSION() AS `version`
query: SELECT * FROM `INFORMATION_SCHEMA`.`COLUMNS` WHERE `TABLE_SCHEMA` = 'test' AND `TABLE_NAME` = 'migrations'
query: CREATE TABLE `migrations` (`id` int NOT NULL AUTO_INCREMENT, `timestamp` bigint NOT NULL, `name` varchar(255) NOT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB
query: SELECT * FROM `test`.`migrations` `migrations` ORDER BY `id` DESC
0 migrations are already loaded in the database.
2 migrations were found in the source code.
2 migrations are new migrations must be executed.
query: START TRANSACTION
query: INSERT INTO `test`.`migrations`(`timestamp`, `name`) VALUES (?, ?) -- PARAMETERS: [1690125367812,"CreateUserTable1690125367812"]
Migration CreateUserTable1690125367812 has been  executed successfully.
query: CREATE TABLE `User` (`id` varchar(255) NOT NULL, `name` varchar(30) NOT NULL, `email` varchar(60) NOT NULL, `password` varchar(30) NOT NULL, `signupVerifyToken` varchar(60) NOT NULL, PRIMARY KEY (`id`)) ENGINE=InnoDB
query: INSERT INTO `test`.`migrations`(`timestamp`, `name`) VALUES (?, ?) -- PARAMETERS: [1690125372875,"CreateUserTable1690125372875"]
Migration CreateUserTable1690125372875 has been  executed successfully.
query: COMMIT
```

4. ë§ˆì´ê·¸ë ˆì´ì…˜ ë¡¤ë°±

```bash
npm run typeorm migration:revert -- -d ./ormconfig.ts

> nest-tutorials@0.0.1 typeorm
> ts-node -r tsconfig-paths/register ./node_modules/typeorm/cli.js migration:revert -d ./ormconfig.ts

query: SELECT VERSION() AS `version`
query: SELECT * FROM `INFORMATION_SCHEMA`.`COLUMNS` WHERE `TABLE_SCHEMA` = 'test' AND `TABLE_NAME` = 'migrations'
query: SELECT * FROM `test`.`migrations` `migrations` ORDER BY `id` DESC
2 migrations are already loaded in the database.
CreateUserTable1690125372875 is the last executed migration. It was executed on Mon Jul 24 2023 00:16:12 GMT+0900 (Korean Standard Time).
Now reverting it...
query: START TRANSACTION
query: DROP TABLE `User`
query: DELETE FROM `test`.`migrations` WHERE `timestamp` = ? AND `name` = ? -- PARAMETERS: [1690125372875,"CreateUserTable1690125372875"]
Migration CreateUserTable1690125372875 has been  reverted successfully.
query: COMMIT
```

## Repository Pattern

ì˜ì†ì„±ì„ ê°€ì§€ëŠ” ì €ì¥ì†Œì— ëŒ€í•œ ë¡œì§ì„ ë°ì´í„°ë ˆì´ì–´ë¡œ ë¶„ë¦¬í•˜ì—¬ ë¹„ì¦ˆë‹ˆìŠ¤ ë¡œì§ê³¼ ë¶„ë¦¬í•˜ëŠ” íŒ¨í„´ì´ë‹¤.

ìƒê¸° íŒ¨í„´ì„ í™œìš©í•˜ë©´ MySQL ë¿ ì•„ë‹ˆë¼ PostgreSQLì„ ë¶™ì´ê±°ë‚˜ ë‹¤ë¥¸ ë°ì´í„° ì†ŒìŠ¤ë¡œë¶€í„° ë°ì´í„°ë¥¼ ì²˜ë¦¬í•  ìˆ˜ ìˆë‹¤.

[ì´ì „ì— ê³µë¶€í•˜ë˜ ë§í¬](https://github.com/s3ich4n/cosmicpython-study/tree/main/pt1/ch02)

[^1]: [ì†ŒìŠ¤ì½”ë“œ ì°¸ê³ : Dependency Injectorì˜ Container ì„¤ì •](https://github.com/s3ich4n/cosmicpython-study/blob/main/pt1/ch07/container.py)
[^2]: [ì†ŒìŠ¤ì½”ë“œ ì°¸ê³ : SQLAlchemyì˜ ì»¤ë„¥ì…˜ì„ ê´€ë¦¬í•˜ëŠ” ê°ì²´](https://github.com/s3ich4n/cosmicpython-study/blob/main/pt1/ch07/src/allocation/adapters/postgres.py)
[^3]: [ì†ŒìŠ¤ì½”ë“œ ì°¸ê³ : FastAPI êµ¬ë™ ë¡œì§](https://github.com/s3ich4n/cosmicpython-study/blob/main/pt1/ch07/src/allocation/entrypoints/app.py)

