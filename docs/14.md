# íƒœìŠ¤í¬ ìŠ¤ì¼€ì¤„ë§

## 14.1 `@nestjs/schedule` íŒ¨í‚¤ì§€

Nestì—ì„œ ì£¼ê¸°ì  ë°˜ë³µì‘ì—…ì„ ì²˜ë¦¬í•˜ê¸° ìœ„í•´ `@nestjs/schedule` íŒ¨í‚¤ì§€ë¥¼ ì‚¬ìš©í•œë‹¤. ì´ëŠ” `node-cron` ì„ í†µí•©í•œ ê²ƒì´ë‹¤.


> `nest g mo batch`
>
> (task.service.ts íŒŒì¼ì€ ìˆ˜ë™ìœ¼ë¡œ ë§Œë“¤ê¸°)

> `src/batch/batch.module.ts`

```ts
import { Module } from '@nestjs/common';
import { ScheduleModule } from '@nestjs/schedule';
import { TaskService } from './task.service';

@Module({
  imports: [ScheduleModule.forRoot()],
  providers: [TaskService],
})
export class BatchModule {}
```

- `ScheduleModule.forRoot()`
    - í¬ë¡ ì¡, íƒ€ì„ì•„ì›ƒ, ì¸í„°ë²Œì„ ë“±ë¡[^1]
    - íƒœìŠ¤í¬ ìŠ¤ì¼€ì¤„ë§ì€ `onApplicationBootstrap`[^2] ìƒëª…ì£¼ê¸° í›… ë°œìƒ ì‹œ ë“±ë¡ë¨
        - `onApplicationBootstrap`: ëª¨ë“  ëª¨ë“ˆì´ ì˜ˆì•½ëœ ì‘ì—…ì„ ë¡œë“œí•˜ê³  í™•ì¸í•˜ëŠ” í›…

## 14.2 íƒœìŠ¤í¬ ìŠ¤ì¼€ì¤„ë§ì„ ì„ ì–¸í•˜ëŠ” ì„¸ ê°€ì§€ ë°©ì‹

ë°©ê¸ˆ ë§Œë“  TaskService í”„ë¡œë°”ì´ë”ë¥¼ í†µí•´ íƒœìŠ¤í¬ ìŠ¤ì¼€ì¤„ë§ì„ ì„ ì–¸í•´ë³´ì.

### 14.2.1 í¬ë¡  ì¡ ì„ ì–¸ ë°©ì‹

`@Cron` ë°ì½”ë ˆì´í„°ë¥¼ ì„ ì–¸í•œ ë©”ì†Œë“œë¥¼ íƒœìŠ¤í¬ë¡œ êµ¬í˜„. ì›í•˜ëŠ” ì‘ì—…ì„ Cron í˜•ì‹ìœ¼ë¡œ ì§€ì •í•´ì£¼ê³ , í•„ìš”í•œ ì˜µì…˜ì„ ì¶”ê°€í•´ì¤€ë‹¤.

```ts
export interface CronOptions {
  name?: string;
  timeZone?: string;
  utcOffset?: string | number;
  unrefTimeout?: boolean;
  disabled?: boolean;
}
```

> `src/batch/task.service.ts`

```ts
import { Injectable, Logger } from '@nestjs/common';
import { Cron } from '@nestjs/schedule';

@Injectable()
export class TaskService {
  private readonly logger = new Logger(TaskService.name);

  @Cron('* * * * * *', { name: 'cronTask' })
  handleCron() {
    this.logger.log('task called');
  }
}
```

ì„œë¹„ìŠ¤ë¥¼ êµ¬ë™í•˜ë©´ ì•„ë˜ì™€ ê°™ì´ ë¡œê·¸ê°€ ì˜ ì°íŒë‹¤.

```log
[2:33:40 AM] Starting compilation in watch mode...

[2:33:43 AM] Found 0 errors. Watching for file changes.

[MyApp] Info    8/7/2023, 2:33:44 AM [NestFactory] Starting Nest application... - {}
[MyApp] Info    8/7/2023, 2:33:44 AM [InstanceLoader] AppModule dependencies initialized - {}

(ìƒëµ)

[MyApp] Info    8/7/2023, 2:33:44 AM [RouterExplorer] Mapped {/users/:id, GET} route - {}
[MyApp] Info    8/7/2023, 2:33:44 AM [NestApplication] Nest application successfully started - {}
[MyApp] Info    8/7/2023, 2:33:45 AM [TaskService] task called - {}
[MyApp] Info    8/7/2023, 2:33:46 AM [TaskService] task called - {}
[MyApp] Info    8/7/2023, 2:33:47 AM [TaskService] task called - {}
[MyApp] Info    8/7/2023, 2:33:48 AM [TaskService] task called - {}
[MyApp] Info    8/7/2023, 2:33:49 AM [TaskService] task called - {}
[MyApp] Info    8/7/2023, 2:33:50 AM [TaskService] task called - {}
```

[^1]: íƒ€ì„ì•„ì›ƒ: ìŠ¤ì¼€ì¤„ë§ì´ ëë‚˜ëŠ” ì‹œê°, ì¸í„°ë²Œ: ì£¼ê¸°ì ìœ¼ë¡œ ë°˜ë³µë˜ëŠ” ì‹œê°„ ê°„ê²©
[^2]: https://docs.nestjs.com/fundamentals/lifecycle-events

`cronTime` í˜•ì‹ìœ¼ë¡œ ê°’ì„ ë„£ì„ ìˆ˜ ìˆë‹¤. E.g.,

- `@Cron(new Date(Date.now() + 3 * 1000))`: ì•± ì‹¤í–‰ í›„ 3ì´ˆ ë’¤ì— ìˆ˜í–‰
- `@Cron(CronExpression.MONDAY_TO_FRIDAY_AT_1AM)`: ì´ëŸ° í‘œí˜„ì´ ìˆìŒ. ì£¼ìš” í‘œí˜„ì€ [í•´ë‹¹ ë§í¬](https://github.com/nestjs/schedule/blob/master/lib/enums/cron-expression.enum.ts)ì°¸ê³ 

> ğŸ…ğŸ… WARNING ğŸ…ğŸ…
>
> `timeZone` ì˜µì…˜ê³¼ `utcOffset` ì˜µì…˜ì„ í•¨ê»˜ ì‚¬ìš©í•˜ì§€ ë§ ê²ƒ!

### 14.2.2 ì¸í„°ë²Œ ì„ ì–¸ ë°©ì‹

- ì²« ì•„ê·œë¨¼íŠ¸: íƒœìŠ¤í¬ ì´ë¦„
- ë‘ë²ˆì§¸ ì•„ê·œë¨¼íŠ¸: íƒ€ì„ì•„ì›ƒ ì‹œê°„(ë°€ë¦¬ì„¸ì»¨ë“œ ë‹¨ìœ„)

```ts
@Interval('intervalTask', 3000)
handleInterval() {
  this.logger.log('Task called by interval');
}
```

ì•± ì‹¤í–‰ í›„ 3ì´ˆ í›„ì— ì‹¤í–‰ë˜ê³ , 3ì´ˆë§ˆë‹¤ ë°˜ë³µë˜ëŠ” íƒœìŠ¤í¬

### 14.2.3 íƒ€ì„ì•„ì›ƒ ì„ ì–¸ ë°©ì‹

ì•± ì‹¤í–‰ ì´í›„ íƒœìŠ¤í¬ë¥¼ ë‹¨ í•œ ë²ˆë§Œ ìˆ˜í–‰í•¨. `@Timeout` ë°ì½”ë ˆì´í„°ë¥¼ ì‚¬ìš©. ì•„ê·œë¨¼íŠ¸ëŠ” ì¸í„°ë²Œ ì„ ì–¸ ë°©ì‹ê³¼ ë™ì¼í•¨

```ts
@Timeout('timeoutTask', 5000)
handleTimeout() {
  this.logger.log('Task called by timeout');
}
```

## 14.3 ë™ì  íƒœìŠ¤í¬ ìŠ¤ì¼€ì¤„ë§

ì•± êµ¬ë™ ì¤‘ íŠ¹ì • ì¡°ê±´ì„ ë§Œì¡±í–ˆì„ ë•Œ íƒœìŠ¤í¬ë¥¼ ë“±ë¡/í•´ì œí•˜ëŠ” ê²½ìš° ì‚¬ìš©í•œë‹¤. ë™ì  íƒœìŠ¤í¬ ìŠ¤ì¼€ì¤„ë§ì€ `SchedulerRegistry`ì—ì„œ ì œê³µí•˜ëŠ” APIë¥¼ ì œê³µí•œë‹¤

> `src/batch/task.service.ts`

```ts
import { Injectable, Logger } from '@nestjs/common';
import { SchedulerRegistry } from '@nestjs/schedule';
import { CronJob } from 'cron';

@Injectable()
export class TaskService {
  private readonly logger = new Logger(TaskService.name);

  constructor(private schedulerRegistry: SchedulerRegistry) {
    this.addCronJob();
  }

  addCronJob() {
    const name = 'cron sample';

    const job = new CronJob('* * * * * *', () => {
      this.logger.warn(`run! ${name}`);
    });

    this.schedulerRegistry.addCronJob(name, job);
    this.logger.warn(`job ${name} added!`);
  }
}
```

- `SchedulerRegistry` ê°ì²´ë¥¼ `TaskService`ì— ì£¼ì…í•œë‹¤
- `TaskService` ê°€ ìƒì„±ë  ë•Œ í¬ë¡ ì¡ í•˜ë‚˜ë¥¼ `SchedulerRegistry`ì— ì¶”ê°€
   - `SchedulerRegistry`ì— í¬ë¡ ì¡ì„ ì¶”ê°€(íƒœìŠ¤í¬ ìŠ¤ì¼€ì¤„ë§ì„ ë“±ë¡í•˜ëŠ” ê²ƒì´ ì•„ë‹˜)

í•´ë‹¹ ì‘ì—…ì„ API í˜¸ì¶œë¡œ ë„ê³  ì¼ ë‹¤ê³  ê°€ì •í•˜ì. ê´€ë ¨ ì½”ë“œëŠ” ì•„ë˜ì™€ ê°™ì´ ì‘ì—…í•  ìˆ˜ ìˆë‹¤. (ë¹ ë¥¸ í…ŒìŠ¤íŠ¸ë¥¼ ìœ„í•´ ì—¬ê¸° ë„£ì—ˆìŒ!)

```ts
import { SchedulerRegistry } from '@nestjs/schedule';

@Controller('users')
export class UsersController {
  constructor(
    @Inject(Logger) private readonly logger: LoggerService,
    (ìƒëµ)
  ) {}
  (ìƒëµ)

  @Post('/start')
  async start() {
    const job = this.scheduler.getCronJob('cronSample');

    job.start();
    console.log(`started at ${job.lastDate()}`);
  }

  @Post('/stop')
  async stop() {
    const job = this.scheduler.getCronJob('cronSample');

    job.stop();
    console.log(`stopped at ${job.lastDate()}`);
  }
```

`POST /users/start` ì™€ `POST /users/stop` ì„ í˜¸ì¶œí•˜ë©´ ì•„ë˜ì™€ ê°™ì´ í¬ë¡ ì¡ì´ ì‹œì‘/ì¤‘ì§€ ë  ìˆ˜ ìˆë‹¤.

```log
[MyApp] Info    8/7/2023, 3:55:19 AM Request to POST /users/start - {} - {}
started at undefined
[MyApp] Info    8/7/2023, 3:55:19 AM Response from POST /users/start 
 response: {} - {}
[MyApp] Warn    8/7/2023, 3:55:20 AM [TaskService] run! cronSample - {}
[MyApp] Warn    8/7/2023, 3:55:21 AM [TaskService] run! cronSample - {}
[MyApp] Warn    8/7/2023, 3:55:22 AM [TaskService] run! cronSample - {}
[MyApp] Warn    8/7/2023, 3:55:23 AM [TaskService] run! cronSample - {}
[MyApp] Info    8/7/2023, 3:55:23 AM Request to POST /users/stop - {} - {}
stopped at Mon Aug 07 2023 03:55:23 GMT+0900 (Korean Standard Time)
[MyApp] Info    8/7/2023, 3:55:23 AM Response from POST /users/stop 
 response: {} - {}

```
